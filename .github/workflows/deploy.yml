name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if checks fail'
        required: false
        default: 'false'
        type: boolean

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check deployment readiness
      id: check
      run: |
        # Check if critical files exist
        critical_files=(
          "supabase/config.toml"
          "package.json"
          "src/main.tsx"
        )
        
        for file in "${critical_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "Critical file missing: $file"
            exit 1
          fi
        done
        
        # Check for deployment markers
        if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        elif git log --format=%B -n 1 | grep -q "\[deploy\]"; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  deploy-functions:
    name: Deploy Supabase Functions
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy functions
      run: |
        supabase functions deploy --project-ref ${{ env.SUPABASE_PROJECT_ID }}
        
    - name: Verify deployment
      run: |
        # Test critical functions
        critical_functions=(
          "lovable-chat"
          "gemini-chat"
          "deepseek-chat"
          "system-status"
        )
        
        for func in "${critical_functions[@]}"; do
          echo "Testing function: $func"
          # Add function health checks here
        done

  deploy-frontend:
    name: Deploy Frontend
    needs: [pre-deploy-checks, deploy-functions]
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for production
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        
    - name: Deploy to Vercel/Netlify
      run: |
        # Add your deployment commands here
        echo "Frontend deployment would happen here"

  post-deploy-validation:
    name: Post-deployment Validation
    needs: [deploy-functions, deploy-frontend]
    runs-on: ubuntu-latest
    
    steps:
    - name: Health check endpoints
      run: |
        # Test critical endpoints
        endpoints=(
          "https://your-project.supabase.co/functions/v1/system-status"
          "https://your-project.supabase.co/functions/v1/lovable-chat"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing endpoint: $endpoint"
          if ! curl -f -s "$endpoint" > /dev/null; then
            echo "❌ Endpoint failed: $endpoint"
            exit 1
          else
            echo "✅ Endpoint healthy: $endpoint"
          fi
        done
        
    - name: Notify deployment status
      run: |
        echo "✅ Deployment completed successfully"
        # Add notification logic (Slack, Discord, etc.)
