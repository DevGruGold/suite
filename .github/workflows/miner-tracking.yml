name: 'XMRT Miner Contribution Tracker'

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all miners'
        required: false
        default: 'false'
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  track-miner-contributions:
    runs-on: ubuntu-latest
    name: 'Track XMRT Miner Contributions'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip
          pip install requests PyGithub python-dateutil
          
      - name: Track Miner Contributions
        id: track-miners
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime, timedelta
          from github import Github
          
          print("ðŸ” XMRT Miner Contribution Tracking Started...")
          
          # Initialize GitHub client
          github_token = os.environ.get('GITHUB_TOKEN')
          if not github_token:
              print("âŒ GitHub token not available")
              exit(0)
          
          g = Github(github_token)
          
          try:
              # Get XMRT repositories to track
              user = g.get_user('DevGruGold')
              xmrt_repos = []
              
              for repo in user.get_repos():
                  if any(keyword in repo.name.lower() for keyword in ['xmrt', 'suite', 'ecosystem']):
                      xmrt_repos.append(repo)
              
              print(f"ðŸ“Š Tracking {len(xmrt_repos)} XMRT repositories")
              
              # Track contributions
              miner_stats = {}
              total_contributions = 0
              
              for repo in xmrt_repos:
                  try:
                      print(f"ðŸ“ˆ Analyzing {repo.name}...")
                      
                      # Get commits from last week
                      since = datetime.now() - timedelta(days=7)
                      commits = repo.get_commits(since=since)
                      
                      repo_commits = 0
                      for commit in commits:
                          if commit.author:
                              author = commit.author.login
                              if author not in miner_stats:
                                  miner_stats[author] = {
                                      'commits': 0,
                                      'repos': set(),
                                      'last_activity': commit.commit.author.date
                                  }
                              miner_stats[author]['commits'] += 1
                              miner_stats[author]['repos'].add(repo.name)
                              repo_commits += 1
                      
                      total_contributions += repo_commits
                      print(f"  â””â”€ {repo_commits} contributions found")
                      
                  except Exception as e:
                      print(f"  â””â”€ âš ï¸ Skipped {repo.name}: {str(e)}")
                      continue
              
              # Convert sets to lists for JSON serialization
              for miner in miner_stats:
                  miner_stats[miner]['repos'] = list(miner_stats[miner]['repos'])
                  miner_stats[miner]['last_activity'] = miner_stats[miner]['last_activity'].isoformat()
              
              # Generate report
              report = {
                  'generated_at': datetime.now().isoformat(),
                  'period': 'Last 7 days',
                  'total_contributions': total_contributions,
                  'active_miners': len(miner_stats),
                  'repositories_tracked': len(xmrt_repos),
                  'miners': miner_stats
              }
              
              print("\nðŸ“‹ XMRT Miner Contribution Report:")
              print(f"  ðŸ”¹ Total Contributions: {total_contributions}")
              print(f"  ðŸ”¹ Active Miners: {len(miner_stats)}")
              print(f"  ðŸ”¹ Repositories: {len(xmrt_repos)}")
              
              # Save report (optional - can be enhanced to save to file)
              print("\nâœ… XMRT Miner tracking completed successfully!")
              
              # Set output for next steps
              print(f"total_contributions={total_contributions}")
              print(f"active_miners={len(miner_stats)}")
              
          except Exception as e:
              print(f"âŒ Error in miner tracking: {str(e)}")
              print("âœ… Continuing workflow execution...")
          
          EOF

      - name: Update Miner Statistics
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ“Š Updating XMRT miner statistics..."
          echo "Miner tracking completed at $(date)"
          
          # Could be enhanced to update README or other files
          # For now, just log completion
          echo "âœ… XMRT miner contribution tracking cycle completed"
          
      - name: Log Completion
        if: always()
        run: |
          echo "ðŸŽ¯ XMRT Miner Contribution Tracker finished"
          echo "Status: $(if [ $? -eq 0 ]; then echo 'SUCCESS'; else echo 'COMPLETED_WITH_WARNINGS'; fi)"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
