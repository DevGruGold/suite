name: Cross-Repo Synchronization
on:
  repository_dispatch:
    types: [sync-repos]
  workflow_dispatch:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'

jobs:
  sync-state:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Trigger sync across all repos
        run: |
          echo "Triggering Supabase sync function..."
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://vawouugtzwmejxqkeqqj.supabase.co/functions/v1/sync-dashboard-data" \
            -H "Authorization: Bearer sb_publishable_yIaroctFhoYStx0f9XajBg_zhpuVulw" \
            -H "Content-Type: application/json" \
            -d '{
                "target_repos": ["suite", "dao-ecosystem", "ecosystem-hub"],
                "force_refresh": true
              }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -c 3)
          echo "Supabase Response Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Sync triggered successfully"
          else
            echo "❌ Sync trigger failed with code $HTTP_CODE"
          fi
      
      - name: Validate data consistency
        run: |
          echo "Validating cross-repo data..."
          curl -s -X GET "https://vawouugtzwmejxqkeqqj.supabase.co/functions/v1/validate-cross-repo-data" \
            -H "Authorization: Bearer sb_publishable_yIaroctFhoYStx0f9XajBg_zhpuVulw" || echo "Validation request failed"
      
      - name: Health check all repos
        run: |
          echo "Checking suite-beta.vercel.app..."
          curl -s -f https://suite-beta.vercel.app/health || echo "⚠️ Suite health check failed"
          
          echo "Checking xmrt-dao-ecosystem.vercel.app..."
          curl -f https://xmrt-dao-ecosystem.vercel.app/health || echo "⚠️ DAO Ecosystem health check failed"
          
          echo "Checking xmrt-ecosystem.vercel.app..."
          curl -f https://xmrt-ecosystem.vercel.app/api/health || echo "⚠️ Ecosystem Hub health check failed"
      
      - name: Report sync status
        run: |
          echo "✅ Synchronization workflow completed"
