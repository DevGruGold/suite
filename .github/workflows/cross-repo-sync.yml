name: Cross-Repo Synchronization

on:
  repository_dispatch:
    types: [sync-repos]
  workflow_dispatch:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'

jobs:
  sync-state:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Trigger sync across all repos
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/sync-dashboard-data"             -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"             -H "Content-Type: application/json"             -d '{
              "target_repos": ["suite", "dao-ecosystem", "ecosystem-hub"],
              "force_refresh": true
            }'
      
      - name: Validate data consistency
        run: |
          curl -X GET "${{ secrets.SUPABASE_URL }}/functions/v1/validate-cross-repo-data"             -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
      
      - name: Health check all repos
        run: |
          echo "Checking suite-beta.vercel.app..."
          curl -f https://suite-beta.vercel.app/health || exit 1
          
          echo "Checking xmrt-dao-ecosystem.vercel.app..."
          curl -f https://xmrt-dao-ecosystem.vercel.app/health || exit 1
          
          echo "Checking xmrt-ecosystem.vercel.app..."
          curl -f https://xmrt-ecosystem.vercel.app/api/health || exit 1
      
      - name: Report sync status
        run: |
          echo "âœ… All repositories synchronized successfully"
