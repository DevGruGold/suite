name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # Daily at 2 AM
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi
        continue-on-error: true
      
      - name: Run npm audit
        run: |
          echo "Running npm security audit..."
          npm audit --audit-level=high || echo "âš ï¸ Some vulnerabilities found, review manually"
        continue-on-error: true
      
      - name: Check for secrets in code
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ” Checking for exposed secrets..."
          
          # Check for common secret patterns
          echo "Checking for API keys..."
          if grep -r -i "api[_-]key.*=.*['"][a-zA-Z0-9]{20,}['"]" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Potential API keys found in code"
          else
            echo "âœ… No obvious API keys found"
          fi
          
          # Check for tokens
          echo "Checking for tokens..."
          if grep -r -i "token.*=.*['"][a-zA-Z0-9]{20,}['"]" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Potential tokens found in code"
          else
            echo "âœ… No obvious tokens found"
          fi
          
          # Check for passwords
          echo "Checking for hardcoded passwords..."
          if grep -r -i "password.*=.*['"][^'"]*['"]" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Potential passwords found in code"
          else
            echo "âœ… No obvious passwords found"
          fi
        continue-on-error: true
      
      - name: Dependency vulnerability scan with Snyk
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: Snyk scan fallback
        if: ${{ secrets.SNYK_TOKEN == '' }}
        run: |
          echo "âš ï¸ SNYK_TOKEN not configured, skipping Snyk scan"
          echo "â„¹ï¸ To enable Snyk scanning:"
          echo "   1. Sign up at https://snyk.io"
          echo "   2. Get your API token"
          echo "   3. Add it as SNYK_TOKEN secret in repository settings"
        continue-on-error: true
      
      - name: Check environment file security
        run: |
          echo "ğŸ” Checking for .env files..."
          
          # Check if .env files are properly gitignored
          if [ -f ".gitignore" ]; then
            if grep -q "^\.env" .gitignore; then
              echo "âœ… .env files are in .gitignore"
            else
              echo "âš ï¸ WARNING: .env should be added to .gitignore"
            fi
          else
            echo "âš ï¸ No .gitignore file found"
          fi
          
          # Check for committed .env files
          if find . -name ".env" -o -name ".env.local" -o -name ".env.*.local" 2>/dev/null | grep -v node_modules | grep -v ".git"; then
            echo "âš ï¸ WARNING: .env files found in repository"
          else
            echo "âœ… No .env files committed"
          fi
        continue-on-error: true
      
      - name: Database security check
        run: |
          echo "ğŸ”’ Running database security checks..."
          
          # Check for SQL injection patterns
          echo "Checking for potential SQL injection vulnerabilities..."
          if grep -r -E "\$\{.*\}.*SELECT|SELECT.*\$\{.*\}" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ supabase/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Potential SQL injection patterns found"
          else
            echo "âœ… No obvious SQL injection patterns"
          fi
          
          # Check Supabase RLS policies
          if [ -d "supabase" ]; then
            echo "âœ… Supabase directory found"
            if [ -f "supabase/config.toml" ]; then
              echo "âœ… Supabase config exists"
            fi
          fi
        continue-on-error: true
      
      - name: API security test
        run: |
          echo "ğŸ” Testing API security..."
          
          # Check for CORS configuration
          echo "Checking CORS configuration..."
          if grep -r "cors" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ 2>/dev/null; then
            echo "âœ… CORS configuration found"
          else
            echo "â„¹ï¸ No CORS configuration detected"
          fi
          
          # Check for rate limiting
          echo "Checking for rate limiting..."
          if grep -r -i "rate.*limit" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist src/ supabase/ 2>/dev/null; then
            echo "âœ… Rate limiting implementation found"
          else
            echo "âš ï¸ Consider implementing rate limiting"
          fi
        continue-on-error: true
      
      - name: Security scan summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ›¡ï¸  Security Scan Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Checks performed:"
          echo "  âœ“ NPM dependency audit"
          echo "  âœ“ Secret detection (basic)"
          echo "  âœ“ Environment file security"
          echo "  âœ“ Database security patterns"
          echo "  âœ“ API security configuration"
          echo ""
          echo "â„¹ï¸ Review warnings above for security improvements"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
